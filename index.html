<!doctype html>



  


<html class="theme-next muse use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="iOS Development, iPhone Development, Android Development, API Development">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="I develop iOS/Android apps with Swift/Kotlin language.">
<meta property="og:type" content="website">
<meta property="og:title" content="Senior Mobile Developer - Vale">
<meta property="og:url" content="http://tuchangwei.github.com/index.html">
<meta property="og:site_name" content="Senior Mobile Developer - Vale">
<meta property="og:description" content="I develop iOS/Android apps with Swift/Kotlin language.">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Senior Mobile Developer - Vale">
<meta name="twitter:description" content="I develop iOS/Android apps with Swift/Kotlin language.">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://tuchangwei.github.com/">

  <title> Senior Mobile Developer - Vale </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Senior Mobile Developer - Vale</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Contact me via changweitu@gmail.com | @cwtututu.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/aboutme" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/04/05/Vapor-4-0-Set-environment-variables-for-swift-test-and-Github-Action/" itemprop="url">
                  [Vapor 4.0]Set Environment Variables for Swift Test and Github Action
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-04-05T15:52:58+08:00" content="Apr 5 2020">
              Apr 5 2020
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Vapor4-0/" itemprop="url" rel="index">
                    <span itemprop="name">Vapor4.0</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/04/05/Vapor-4-0-Set-environment-variables-for-swift-test-and-Github-Action/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/05/Vapor-4-0-Set-environment-variables-for-swift-test-and-Github-Action/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>When we run test casts, we don’t want to use our development database, we want to use a new database for testing. In Xcode, it is easy to set. Under the <code>Run</code> tab, we don’t set the database information, but Under the <code>Test</code> tab, we set the database information.</p>
<img src="/2020/04/05/Vapor-4-0-Set-environment-variables-for-swift-test-and-Github-Action/WX20200405-160058@2x.png">
<img src="/2020/04/05/Vapor-4-0-Set-environment-variables-for-swift-test-and-Github-Action/WX20200405-160133@2x.png">
<p>But do you know how to set these variables via command line? Here it is:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export <span class="type">DATABASE_PORT</span>=<span class="string">"5433"</span>; export <span class="type">DATABASE_USERNAME</span>=<span class="string">"test"</span>; export <span class="type">DATABASE_PASSWORD</span>=<span class="string">"test"</span>; export <span class="type">DATABASE_NAME</span>=<span class="string">"test"</span>; swift test</span><br></pre></td></tr></table></figure>
<p>Now, CI(continutal Integration) is popular, today I also try to run test when I push my code to Github reposity. After some failture, here is the right <code>yml</code> file.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">name: test</span><br><span class="line">on:</span><br><span class="line">  push:</span><br><span class="line">jobs:</span><br><span class="line">  test:</span><br><span class="line">    container:</span><br><span class="line">      image: vapor/swift:<span class="number">5.2</span></span><br><span class="line">    services:</span><br><span class="line">      psql:</span><br><span class="line">        image: postgres</span><br><span class="line">        ports:</span><br><span class="line">          - <span class="number">5432</span>:<span class="number">5432</span></span><br><span class="line">        env:</span><br><span class="line">          <span class="type">POSTGRES_USER</span>: test</span><br><span class="line">          <span class="type">POSTGRES_DB</span>: test</span><br><span class="line">          <span class="type">POSTGRES_PASSWORD</span>: test</span><br><span class="line">    runs-on: ubuntu-latest </span><br><span class="line">    </span><br><span class="line">    steps:</span><br><span class="line">      - name: '<span class="type">Checking</span> out repo'	       </span><br><span class="line">        uses: actions/checkout@v2	</span><br><span class="line">      - name: '<span class="type">Running</span> <span class="type">Integration</span> <span class="type">Tests'</span>	</span><br><span class="line">				run: swift test --enable-test-discovery --sanitize=thread</span><br><span class="line">        env:</span><br><span class="line">         <span class="type">DATABASE_PORT</span>: <span class="number">5432</span></span><br><span class="line">         <span class="type">DATABASE_USERNAME</span>: test</span><br><span class="line">         <span class="type">DATABASE_PASSWORD</span>: test</span><br><span class="line">         <span class="type">DATABASE_NAME</span>: test</span><br><span class="line">         <span class="type">DATABASE_HOST</span>: psql</span><br></pre></td></tr></table></figure>
<p>I had thought to change the database port to <code>5433</code>, but it seems a bug of Github Action. After I changed it back to <code>5432</code>, it works.</p>
<p>Thanks to <a href="https://twitter.com/0xTim" target="_blank" rel="noopener">@0xTim</a> for discussion about it.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/04/04/Vapor-4-0-How-to-write-test-cases-to-test-routes-that-render-model-to-Leaf-page/" itemprop="url">
                  [Vapor 4.0]How to Write Test Cases to Test Routes That Render Model to Leaf Page
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-04-04T22:45:06+08:00" content="Apr 4 2020">
              Apr 4 2020
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/04/04/Vapor-4-0-How-to-write-test-cases-to-test-routes-that-render-model-to-Leaf-page/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/04/Vapor-4-0-How-to-write-test-cases-to-test-routes-that-render-model-to-Leaf-page/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>You want to write test cases for every route right? Yes, I want too. But today, I met a question - How to write test cases to test routes that render model to Leaf page?</p>
<p>We all know testing html is complicated, I want to test the model which will be rendered to the html page, but how?</p>
<p>Let’s see the answer.</p>
<p>First, we need to write our <code>ViewRender</code>, we want to use the custom ViewRender to get the model before it is rendered to html page.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vapor</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CapturingViewRenderer</span>: <span class="title">ViewRenderer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> shouldCache = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> eventLoop: <span class="type">EventLoop</span></span><br><span class="line">    <span class="keyword">init</span>(eventLoop: <span class="type">EventLoop</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.eventLoop = eventLoop</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> `<span class="title">for</span>`<span class="params">(<span class="number">_</span> request: Request)</span></span> -&gt; <span class="type">ViewRenderer</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> capturedContext: <span class="type">Encodable?</span></span><br><span class="line">    <span class="keyword">private</span>(<span class="keyword">set</span>) <span class="keyword">var</span> templatePath: <span class="type">String?</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">render</span>&lt;E&gt;<span class="params">(<span class="number">_</span> name: String, <span class="number">_</span> context: E)</span></span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">View</span>&gt; <span class="keyword">where</span> <span class="type">E</span> : <span class="type">Encodable</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.capturedContext = context</span><br><span class="line">        <span class="keyword">self</span>.templatePath = name</span><br><span class="line">        <span class="keyword">let</span> string = <span class="string">"I just want to get the context and the templatePath, I don't care what the view will look like"</span></span><br><span class="line">        <span class="keyword">var</span> byteBuffer = <span class="type">ByteBufferAllocator</span>().buffer(capacity: string.<span class="built_in">count</span>)</span><br><span class="line">        byteBuffer.writeString(string)</span><br><span class="line">        <span class="keyword">let</span> view = <span class="type">View</span>(data: byteBuffer)</span><br><span class="line">        <span class="keyword">return</span> eventLoop.future(view)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You see, we get the rendering destination <code>templatePath</code>, and the context <code>capturedContext</code>. Maybe you don’t know what context is, just see the route hander, you will undertand.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getArticlesHandler</span><span class="params">(req: Request)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">View</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Article</span>.query(on: req.db).all().flatMap &#123;</span><br><span class="line">            <span class="keyword">return</span> req.view.render(<span class="string">"Home"</span>,  <span class="type">HomeContext</span>(articles: $<span class="number">0</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>The HomeContext is the Context the Leaf framework needs, it wraps our model.</p>
<p>Second, we need to register the ViewRender to our app.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleRoutesTests</span>: <span class="title">XCTestCase</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> app: <span class="type">Application!</span></span><br><span class="line">    <span class="keyword">let</span> url = <span class="string">"/articles"</span></span><br><span class="line">    <span class="keyword">let</span> articleName = <span class="string">"Swift"</span></span><br><span class="line">    <span class="keyword">let</span> articleBody = <span class="string">"This is my first post"</span></span><br><span class="line">    <span class="keyword">var</span> capturingViewRender: <span class="type">CapturingViewRenderer!</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setUpWithError</span><span class="params">()</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">        app = <span class="type">Application</span>(.testing)</span><br><span class="line">        <span class="keyword">try</span> configure(app)</span><br><span class="line">        capturingViewRender = <span class="type">CapturingViewRenderer</span>(eventLoop: app.eventLoopGroup.next())</span><br><span class="line">        app.views.use &#123;<span class="number">_</span> <span class="keyword">in</span> <span class="keyword">self</span>.capturingViewRender &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Third, write the test case to compare the route path and model.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testGetArticles</span><span class="params">()</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> <span class="type">Utils</span>.cleanDatabase(db: app.db)</span><br><span class="line">      <span class="keyword">let</span> article = <span class="type">Article</span>(name: articleName, body: articleBody)</span><br><span class="line">      <span class="keyword">try</span> article.save(on: app.db).wait()</span><br><span class="line">      <span class="keyword">try</span> app.test(.<span class="type">GET</span>, url) &#123; res <span class="keyword">in</span></span><br><span class="line">          <span class="keyword">let</span> context = <span class="keyword">try</span> <span class="type">XCTUnwrap</span>(capturingViewRender.capturedContext <span class="keyword">as</span>? <span class="type">ArticleController</span>.<span class="type">HomeContext</span>)</span><br><span class="line">          <span class="type">XCTAssert</span>(capturingViewRender.templatePath == <span class="string">"Home"</span>, <span class="string">"render to wrong page"</span>)</span><br><span class="line">          <span class="type">XCTAssertTrue</span>(context.articles?.<span class="built_in">count</span> == <span class="number">1</span>, <span class="string">"GET /articles api failed."</span>)</span><br><span class="line">          <span class="type">XCTAssertTrue</span>(context.articles?.first?.name == articleName, <span class="string">"GET /articles api failed."</span>)</span><br><span class="line">          <span class="type">XCTAssertTrue</span>(context.articles?.first?.body == articleBody, <span class="string">"GET /articles api failed."</span>)</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Done! Enjoy testing.</p>
<p>Thanks to <a href="https://twitter.com/0xTim" target="_blank" rel="noopener">@0xTim</a> for discussion about it.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/04/01/Vapor4-0发送Post及Leaf渲染/" itemprop="url">
                  Vapor4.0发送Post及Leaf渲染
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-04-01T22:12:36+08:00" content="Apr 1 2020">
              Apr 1 2020
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/04/01/Vapor4-0发送Post及Leaf渲染/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/04/01/Vapor4-0发送Post及Leaf渲染/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天填了两个坑。</p>
<p>1,  Post 创建文章。<code>Article</code> database Model结构为:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Article</span>: <span class="title">Model</span>, <span class="title">Content</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> schema: <span class="type">String</span> = <span class="string">"articles"</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> idKey: <span class="type">FieldKey</span> = .id</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> nameKey: <span class="type">FieldKey</span> = <span class="string">"name"</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> slugKey: <span class="type">FieldKey</span> = <span class="string">"slug"</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> bodyKey: <span class="type">FieldKey</span> = <span class="string">"body"</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> categoryIDKey: <span class="type">FieldKey</span> = <span class="string">"category_id"</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> createdKey: <span class="type">FieldKey</span> = <span class="string">"created_at"</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> updatedKey: <span class="type">FieldKey</span> = <span class="string">"updated_at"</span></span><br><span class="line">    </span><br><span class="line">    @<span class="type">ID</span>(key: idKey)</span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">UUID?</span></span><br><span class="line">    </span><br><span class="line">    @<span class="type">Field</span>(key: nameKey)</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    </span><br><span class="line">    @<span class="type">Field</span>(key: slugKey)</span><br><span class="line">    <span class="keyword">var</span> slug: <span class="type">String?</span></span><br><span class="line">    </span><br><span class="line">    @<span class="type">Field</span>(key: bodyKey)</span><br><span class="line">    <span class="keyword">var</span> body: <span class="type">String</span></span><br><span class="line">   </span><br><span class="line">    @<span class="type">OptionalParent</span>(key: categoryIDKey)</span><br><span class="line">    <span class="keyword">var</span> category: <span class="type">ArticleCategory?</span></span><br><span class="line">    </span><br><span class="line">    @<span class="type">Timestamp</span>(key: createdKey, on: .create)</span><br><span class="line">    <span class="keyword">var</span> createdAt: <span class="type">Date?</span></span><br><span class="line">    </span><br><span class="line">    @<span class="type">Timestamp</span>(key: updatedKey, on: .update)</span><br><span class="line">    <span class="keyword">var</span> updatedAt: <span class="type">Date?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">init</span>(name: <span class="type">String</span>, body:<span class="type">String</span>, categoryID: <span class="type">UUID?</span> = <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.name = name</span><br><span class="line">        <span class="keyword">self</span>.body = body</span><br><span class="line">        <span class="keyword">self</span>.$category.id = categoryID</span><br><span class="line">        <span class="keyword">self</span>.slug = <span class="string">"\(Date().formatedString())\(name.split(separator: "</span> <span class="string">").joined(separator: "</span>-<span class="string">"))"</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Article</code> database model中， 我创建了一个父关系<code>category</code>, 但这个项目中，我并不打算让每篇文章都有一个类别，所以我把父关系设置为可选类型。但是post的时候并不能把<code>category</code>这个字段省略，请求的格式必须这样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"body"</span>: <span class="string">"Hello, my first blog."</span>,</span><br><span class="line">  "category": &#123;&#125;,//或者 "category": &#123; "id": null &#125;,</span><br><span class="line">  "name": "my first blog"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是不是很不合理？前端拿到这个API会比较迷惑，组建json的时候，这个字段没有值，不能不写这个key-value pair, 也不能写成<code>category:null</code> 。社区中大神给出的方案是用一个不含<code>category</code>字段的结构体先接收，然后再转成<code>database mode</code>的样子。具体解释请参考<a href="https://github.com/vapor/vapor/issues/2280" target="_blank" rel="noopener">这里</a></p>
<p>2, Leaf渲染。Vapor4的文档还没有出，Leaf的定义也与Vapor3有很大的改变，这就难为死我了。这种情况下，只能去扒一扒Test里面写的测试用例了。坑如下：</p>
<figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;<span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">title</span>)</span></span>&lt;/p&gt;</span><br><span class="line"><span class="function"><span class="keyword">#</span><span class="title">if</span><span class="params">(!<span class="variable">articles</span>.<span class="variable">isEmpty</span>)</span></span>:</span><br><span class="line">    &lt;p&gt;<span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">title</span>)</span></span>&lt;/p&gt;</span><br><span class="line">    <span class="function"><span class="keyword">#</span><span class="title">for</span><span class="params">(<span class="variable">article</span> <span class="variable">in</span> <span class="variable">articles</span>)</span></span>:</span><br><span class="line">        &lt;p&gt;<span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">article</span>)</span></span>&lt;/p&gt;</span><br><span class="line">    #endfor</span><br><span class="line">#else:</span><br><span class="line">&lt;p&gt;no artcile&lt;/p&gt;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>遍历打印文章是打印不到的。必须是打印文章的属性，如下写法是正确的：</p>
<figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;<span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">title</span>)</span></span>&lt;/p&gt;</span><br><span class="line"><span class="function"><span class="keyword">#</span><span class="title">if</span><span class="params">(!<span class="variable">articles</span>.<span class="variable">isEmpty</span>)</span></span>:</span><br><span class="line">    &lt;p&gt;<span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">title</span>)</span></span>&lt;/p&gt;</span><br><span class="line">    <span class="function"><span class="keyword">#</span><span class="title">for</span><span class="params">(<span class="variable">article</span> <span class="variable">in</span> <span class="variable">articles</span>)</span></span>:</span><br><span class="line">        &lt;p&gt;<span class="function"><span class="keyword">#</span><span class="params">(<span class="variable">article</span>.<span class="variable">name</span>)</span></span>&lt;/p&gt;//&lt;--注意这里</span><br><span class="line">    #endfor</span><br><span class="line">#else:</span><br><span class="line">&lt;p&gt;no artcile&lt;/p&gt;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>填坑完毕。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/31/Vapor4-0数据库增加字段/" itemprop="url">
                  Vapor4.0数据库增加字段
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-31T16:32:13+08:00" content="Mar 31 2020">
              Mar 31 2020
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/03/31/Vapor4-0数据库增加字段/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/31/Vapor4-0数据库增加字段/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Question is following: How to implement additional migration on already existing table without revert or recreating DB?<br>Original migration:<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CreateTile</span>: <span class="title">Migration</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Prepares the database for storing Tile models.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(on database: Database)</span></span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">        database.schema(<span class="string">"tiles"</span>)</span><br><span class="line">            .id()</span><br><span class="line">            .field(<span class="string">"x"</span>, .int, .<span class="keyword">required</span>)</span><br><span class="line">            .field(<span class="string">"y"</span>, .int, .<span class="keyword">required</span>)</span><br><span class="line">            .field(<span class="string">"z"</span>, .int, .<span class="keyword">required</span>)</span><br><span class="line">            .create()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Optionally reverts the changes made in the prepare method.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">revert</span><span class="params">(on database: Database)</span></span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">        database.schema(<span class="string">"tiles"</span>).delete()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Now you want to extend the table by additional column called  new which is of type Int. Therefore you have to implement new migration.<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">UpdateTile</span>: <span class="title">Migration</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Prepares the database for storing Tile models.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(on database: Database)</span></span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">        database.schema(<span class="string">"tiles"</span>)</span><br><span class="line">            .field(<span class="string">"new"</span>, .int)</span><br><span class="line">            .update()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Optionally reverts the changes made in the prepare method.</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">revert</span><span class="params">(on database: Database)</span></span> -&gt; <span class="type">EventLoopFuture</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">        database.schema(<span class="string">"tiles"</span>).deleteField(<span class="string">"new"</span>).update()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Last step is to register your new migration in configure.swift file similar as the original one</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/24/Vapor4-0写一些测试/" itemprop="url">
                  Vapor4.0写一些测试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-24T13:21:52+08:00" content="Mar 24 2020">
              Mar 24 2020
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Vapor4-0/" itemprop="url" rel="index">
                    <span itemprop="name">Vapor4.0</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/03/24/Vapor4-0写一些测试/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/24/Vapor4-0写一些测试/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>没有文档的情况下，一切都靠摸索。刚开始的时候都不知道怎么下手，看看Vapor的测试怎么写，看看Fluent的测试怎么写。万事开头难，总算摸出个头绪。</p>
<p>首先，要配置测试环境, 在Xcode中的配置如下。<br><img src="/2020/03/24/Vapor4-0写一些测试/WX20200324-134857.png"><br>然后新建测试数据库。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="builtin-name">run</span> --name postgres-test -e <span class="attribute">POSTGRES_DB</span>=test \</span><br><span class="line">-e <span class="attribute">POSTGRES_USER</span>=test -e <span class="attribute">POSTGRES_PASSWORD</span>=test \</span><br><span class="line">-p 5433:5432 -d postgres</span><br></pre></td></tr></table></figure></p>
<p>测试一下:<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testDatabaseConfig</span><span class="params">()</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> app = <span class="type">Application</span>(.testing)</span><br><span class="line">    <span class="keyword">defer</span> &#123; app.shutdown() &#125;</span><br><span class="line">    <span class="keyword">try</span> configure(app)</span><br><span class="line">    <span class="type">XCTAssertTrue</span>(<span class="type">Int</span>(<span class="type">Environment</span>.<span class="keyword">get</span>(<span class="string">"DATABASE_PORT"</span>) ?? <span class="string">"5432"</span>)! == <span class="number">5433</span>, <span class="string">"DATABASE_PORT is wrong"</span>)</span><br><span class="line">    <span class="type">XCTAssertTrue</span>(<span class="type">Environment</span>.<span class="keyword">get</span>(<span class="string">"DATABASE_USERNAME"</span>) == <span class="string">"test"</span>, <span class="string">"DATABASE_USERNAME is wrong"</span>)</span><br><span class="line">    <span class="type">XCTAssertTrue</span>(<span class="type">Environment</span>.<span class="keyword">get</span>(<span class="string">"DATABASE_PASSWORD"</span>) == <span class="string">"test"</span>, <span class="string">"DATABASE_PASSWORD is wrong"</span>)</span><br><span class="line">    <span class="type">XCTAssertTrue</span>(<span class="type">Environment</span>.<span class="keyword">get</span>(<span class="string">"DATABASE_NAME"</span>) == <span class="string">"test"</span>, <span class="string">"DATABASE_PASSWORD is wrong"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>测试新建表格是否成功:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func testArticleTable() throws &#123;</span><br><span class="line">    let app = Application(.testing)</span><br><span class="line">    defer &#123; app.shutdown() &#125;</span><br><span class="line">    <span class="keyword">try</span> configure(app)</span><br><span class="line">    let article = Article(<span class="built_in">name</span>: <span class="string">"title"</span>, body: <span class="string">"body"</span>, categoryID: nil)</span><br><span class="line">    <span class="keyword">try</span> article.save(<span class="keyword">on</span>: app.db).wait()</span><br><span class="line">    let articles = <span class="keyword">try</span> Article.query(<span class="keyword">on</span>: app.db).all().wait()</span><br><span class="line">    XCTAssertEqual(articles.<span class="built_in">count</span>, <span class="number">1</span>)</span><br><span class="line">    XCTAssertEqual(articles.<span class="keyword">first</span>?.<span class="built_in">name</span>, <span class="string">"title"</span>)</span><br><span class="line">    XCTAssertEqual(articles.<span class="keyword">first</span>?.body, <span class="string">"body"</span>)</span><br><span class="line">    XCTAssertNil(articles.<span class="keyword">first</span>?.category)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>其中在<code>configure.swift</code>文件中加入一些辅助方法调用，使测试之前清空数据库。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public func configure(_ <span class="keyword">app</span>: Application) throws &#123;</span><br><span class="line">    <span class="comment">// uncomment to serve files from /Public folder</span></span><br><span class="line">    <span class="keyword">app</span>.middleware.<span class="keyword">use</span>(FileMiddleware(publicDirectory: <span class="keyword">app</span>.directory.publicDirectory))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">app</span>.databases.<span class="keyword">use</span>(.postgres(</span><br><span class="line">        hostname: Environment.<span class="built_in">get</span>(<span class="string">"DATABASE_HOST"</span>) ?? <span class="string">"localhost"</span>,</span><br><span class="line">        port: Int(Environment.<span class="built_in">get</span>(<span class="string">"DATABASE_PORT"</span>) ?? <span class="string">"5432"</span>) ?? 5432,</span><br><span class="line">        username: Environment.<span class="built_in">get</span>(<span class="string">"DATABASE_USERNAME"</span>) ?? <span class="string">"vapor_username"</span>,</span><br><span class="line">        password: Environment.<span class="built_in">get</span>(<span class="string">"DATABASE_PASSWORD"</span>) ?? <span class="string">"vapor_password"</span>,</span><br><span class="line">        database: Environment.<span class="built_in">get</span>(<span class="string">"DATABASE_NAME"</span>) ?? <span class="string">"vapor_database"</span></span><br><span class="line">    ), <span class="keyword">as</span>: .psql)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">app</span>.migrations.add(CreateArticleGategory())</span><br><span class="line">    <span class="keyword">app</span>.migrations.add(CreateArticle())</span><br><span class="line">    <span class="comment">//&lt;==如果是测试环境，则清空数据库。注意这三行代码的位置要放在add方法之下的。</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">app</span>.environment == .testing &#123;</span><br><span class="line">        try <span class="keyword">app</span>.autoRevert().wait()</span><br><span class="line">        try <span class="keyword">app</span>.autoMigrate().wait()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开启页面渲染</span></span><br><span class="line">    <span class="keyword">app</span>.views.<span class="keyword">use</span>(.leaf)</span><br><span class="line">    <span class="keyword">app</span>.leaf.cache.isEnabled = false</span><br><span class="line">    <span class="comment">// register routes</span></span><br><span class="line">    try routes(<span class="keyword">app</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/20/Vapor4-0加入数据库/" itemprop="url">
                  Vapor4.0加入数据库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-20T16:01:06+08:00" content="Mar 20 2020">
              Mar 20 2020
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Vapor4-0/" itemprop="url" rel="index">
                    <span itemprop="name">Vapor4.0</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/03/20/Vapor4-0加入数据库/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/20/Vapor4-0加入数据库/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天主要是操作postgres数据库，验证表关系，主要测试联机删除和外键为空的情况。</p>
<p>数据库中建了文章表(子表)和类别表(父表)，类别表的主键是文章表的外键，文章表的外键约束是联机删除，它的意思是当删除类别表的某项记录时，文章表里和此类别记录有关的记录都会被删除。逻辑好绕。</p>
<p>访问postgres数据库有两种方式，一种是先进入容器，然后访问。进入容器我用的是Code的Docker插件进入的。进去之后输入用户名和数据库名就进去了。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">psql</span> -U vapor_username -d vapor_database</span><br></pre></td></tr></table></figure>
<p>另一种方式是用Terminal访问，也就是从容器外访问。首先安装postgres到本地。<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">brew </span><span class="keyword">install </span>postgresql</span><br></pre></td></tr></table></figure></p>
<p>然后命令:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -U vapor_username -d vapor_database -h localhost -<span class="selector-tag">p</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure></p>
<p>我因为以前一直开着Proxifier，导致访问5432端口都给转发给1081端口了，所以一直登陆不上，看了Proxifier中的日志才发现这个问题。</p>
<p>从大学毕业就没写过SQL语句了，postgres也是第一次用，测试外键费了不少功夫。如下插入的语句，因为忘记打最后面的分号，psql还在等我输入，我又输入查询语句，啥也没显示，后面查查才知道后面要带分号。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> articles(<span class="keyword">id</span>, <span class="keyword">name</span>, <span class="keyword">body</span>, category_id) <span class="keyword">VALUES</span>(<span class="string">'40e6215d-b5c6-4896-987c-f30f3678f604'</span>,<span class="string">'hello'</span>,<span class="string">'my name is vale'</span>,<span class="string">'40e6215d-b5c6-4896-987c-f30f3678f604'</span>);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/18/Vapor4-0对docker-compose文件浅析/" itemprop="url">
                  Vapor4.0对docker-Compose文件浅析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-18T10:46:20+08:00" content="Mar 18 2020">
              Mar 18 2020
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Vapor4-0/" itemprop="url" rel="index">
                    <span itemprop="name">Vapor4.0</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/03/18/Vapor4-0对docker-compose文件浅析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/18/Vapor4-0对docker-compose文件浅析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上篇对<code>docker-compose.yml</code>的某些理解有误，这篇对某些命令进行浅解。<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-f Dockerfile -t tblog .</span><br></pre></td></tr></table></figure></p>
<p>那个<code>.</code>是指上下文路径，参见<a href="https://yeasy.gitbooks.io/docker_practice/image/build.html" target="_blank" rel="noopener">这里</a>-<strong>镜像构建上下文(Context)</strong></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose build</span></span><br></pre></td></tr></table></figure>
<p>这个命令为啥先去运行<code>Dockerfile</code>里的命令呢？因为这个文件是用来构建<code>tblog:latest</code>镜像的。在<code>docker-compose.xml</code>中的首要任务就是构建<code>tblog:latest</code>， 并指定了build所需要的上下文, docker就找到上下文中的<code>Dockerfile</code>进行编辑了。就是下面这一段。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr"> app:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">tblog:latest</span></span><br><span class="line"><span class="attr">    build:</span></span><br><span class="line"><span class="attr">      context:</span> <span class="string">.</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure></p>
<p><code>docker-compose.xml</code>最上面有一段：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">volumes:</span></span><br><span class="line"><span class="symbol">  db_data:</span></span><br><span class="line">  ....</span><br></pre></td></tr></table></figure></p>
<p>这个是干嘛的呢？这个是创建一个磁盘。<code>db_data:</code>应该就相当于我们说的盘符。没有给这个盘指定名称，它会有个默认的名称<code>tblog_db_data</code>, 也可以这样指定磁盘的名称。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">volumes:</span></span><br><span class="line"><span class="symbol">  db_data:</span></span><br><span class="line"><span class="symbol">    name:</span> <span class="string">"tuchangwei"</span></span><br></pre></td></tr></table></figure>
<p>磁盘是用来存数据的，它不会消失。多个容器也可以共享这个磁盘。我们的数据库就把数据放在这个磁盘里面:<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">db:</span></span><br><span class="line">    <span class="symbol">image:</span> <span class="symbol">postgres:</span><span class="number">12.1</span>-alpine</span><br><span class="line">    <span class="symbol">volumes:</span></span><br><span class="line">       - <span class="symbol">db_data:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">postgresql</span>/<span class="title">data</span>/<span class="title">pgdata</span></span></span><br></pre></td></tr></table></figure></p>
<p>对于<code>docker-compose.xml</code>文件里命令的解释，可以参考<a href="https://docs.docker.com/compose/compose-file/#depends_on" target="_blank" rel="noopener">这里</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/15/Vapor4-0对Dockerfile文件浅析/" itemprop="url">
                  Vapor4.0对Dockerfile文件浅析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-15T10:54:37+08:00" content="Mar 15 2020">
              Mar 15 2020
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Vapor4-0/" itemprop="url" rel="index">
                    <span itemprop="name">Vapor4.0</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/03/15/Vapor4-0对Dockerfile文件浅析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/15/Vapor4-0对Dockerfile文件浅析/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>昨天周六，被Docker中配置Vapor搞到脑袋要炸，差一点放弃Vapor的学习。但今天感觉还好，脑炸是源于对未知的恐惧。</p>
<p>本身相关的包依赖下载就非常的耗时，稍个不慎还要重新下载，简直奔溃。</p>
<p>我的想法是先建个模版项目发布一下，熟悉整个流程后，就边加功能边发布。因为要保持环境的一致性，Vapor社区比较推荐在Docker中部署，然后再把Docker部署到服务器上，模版项目中也提供了两个Docker相关的文件 <code>Dockerfile</code> 和 <code>docker-compose.yml</code>。但是网络上关于Docker部署Vapor4的资料简直是没有，看着两个文件中的命令就头大。脑中的问题一直在飞： 本地项目怎么部署到Docker容器中？是不是要先在容器中安装Swift和Postpostgres?部署的项目和postpostrges是同一个容器，还是两个容器？这两个容器怎么交流？本地项目做了更改后，Docker中的项目会自动更改吗？这些问题怎么用命令行解决？谁想谁脑炸。</p>
<p>正当我要放弃的时候，社区的温暖送来了🙏。</p>
<blockquote>
<p>Deploying with docker is quite easy. Assuming you want to deploy a fresh Vapor 4 project:</p>
</blockquote>
<blockquote>
<p>Requirements: Install latest Xcode 11.4 Beta and switch to Swift 5.2 in the preferences. (You can check in the command line using swift –version) If you want to use Docker locally on your Mac, you should install Docker Desktop for Mac. </p>
</blockquote>
<blockquote>
<p>Run <code>vapor new --branch=4 myProject</code> to create a fresh project from template. (You can do any changes if you want, but the fresh template already provides a Hello World example.)</p>
</blockquote>
<blockquote>
<p>To run your application within Docker, there is already a <code>web.Dockerfile</code> provided in the template.<br>We’ll have to build an image first. Run <code>docker build -f web.Dockerfile -t my-project .</code>  Of course you can use whatever tag (my-project) you like.<br>To test your image locally use <code>docker run --rm -p 8080:80 my-project</code> (We use –rm to delete the container when we stop the app. The flag -p 8080:80 exposes the port 80 from within the container to port 8080 on our host.) You will see something like [ NOTICE ] Server starting on <a href="http://0.0.0.0:80" target="_blank" rel="noopener">http://0.0.0.0:80</a> in the command line. Visit <a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a> in your browser and you should see “It works!” from your Vapor application.</p>
</blockquote>
<blockquote>
<p>If you make changes to your application, stop the container, build and run it again.</p>
</blockquote>
<p>所以什么都不用管，先在项目目录下输入如下命令:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-f Dockerfile -t tblog .</span><br></pre></td></tr></table></figure>
<p>项目就开始在Docker中安装了。注意命令后面那个<code>.</code>别忘了，那个是当前目录的意思。</p>
<p>完后我按照上面大佬的命令：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> <span class="comment">--rm -p 8080:80 tblog</span></span><br></pre></td></tr></table></figure></p>
<p>并没有把项目跑起来，这里可以从两处做一下更改。一个是把命令行改成：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> <span class="comment">--rm -p 8080:8080 tblog</span></span><br></pre></td></tr></table></figure></p>
<p>因为另一个大佬说docker默认暴露的是8080端口。或者在<code>Dockerfile</code>文件中把最后一行改为：</p>
<blockquote>
<p>CMD [“serve”, “–env”, “production”, “–hostname”, “0.0.0.0”, “–port”, “80”]</p>
</blockquote>
<p>把80端口暴露出来。</p>
<p><code>Dockerfile</code>里的命令大概解释一下，就是先在Docker容器里下载Swift5.2, 然后把本地的项目拷贝到容器里，然后编译。然后再把Ubuntu拷贝下来，把编译的文件放在Ubuntu的目录结构下。然后运行。</p>
<p>这个时候项目跑起来是没有数据库的, <code>docker-compose.yml</code>这个文件就有用了。</p>
<p>运行命令：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="meta">up</span> <span class="built_in">db</span></span><br></pre></td></tr></table></figure></p>
<p>会安装数据库postgres，并启动数据库。</p>
<p>运行命令：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose up migrate</span></span><br></pre></td></tr></table></figure></p>
<p>会在数据库中创建TODO这个表。</p>
<p>这个时候，你再访问localhost:8080/todos这个API程序就不会报错了。这个数据库是建在另外一个容器里的。我们既可以通过运行命令：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose up app</span></span><br></pre></td></tr></table></figure></p>
<p>让前一个容器里的app启动，然后通过localhost:8080/todos去访问数据库，也可以直接在Xcode中运行app，然后通过这个URL去访问数据库。数据库是同一个，但是跑起来的app却是两个。Xcode跑的那个是开发用的。容器里的这个用来发布的。</p>
<p>如果运行命令：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose build</span></span><br></pre></td></tr></table></figure></p>
<p>它会执行<code>Dockerfile</code>里的命令。也就是说和前面docker build的命令差不多。</p>
<p>这些命令在<code>docker-compose.yml</code>中都有说明。</p>
<p>最后我发现原来docker在国内有镜像，可以加速下载images。具体方法看<a href="https://yeasy.gitbooks.io/docker_practice/install/mirror.html" target="_blank" rel="noopener">这里</a>。这个博客很不错，回头看看把Docker的知识补一补。</p>
<p>文中关于Docker的解释，我半靠理解半靠猜，但无论如何app是跑起来了，数据库也通了。后面慢慢练手，慢慢填坑。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/13/Vapor4-0Xcode传参/" itemprop="url">
                  Vapor4.0Xcode传参
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-13T20:50:10+08:00" content="Mar 13 2020">
              Mar 13 2020
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Vapor4-0/" itemprop="url" rel="index">
                    <span itemprop="name">Vapor4.0</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/03/13/Vapor4-0Xcode传参/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/13/Vapor4-0Xcode传参/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>太难了。</p>
<p>每一个项目都要重新下载Swift Package Dependencies，并不会把相同的库像Nodejs那样全局地装在本地。</p>
<p>命令行运行和Xcode运行，他们需要下载的Swift Package Dependencies在不同的位置。我本来在Xcode配置环境变量，想用命令行验证一下，结果，命令行也要重新下载一遍这些包。黑脸…</p>
<p>记录一下Xcode中环境配置的位置吧。上边可以配置环境。下边可以配置数据库的信息。</p>
<img src="/2020/03/13/Vapor4-0Xcode传参/QQ20200313-210331.png">
<p>大神说命令行配置应该这样 <code>EXPORT DATABASE_HOST=vapor; vapor-beta run</code>, 因为命令行下包还没下下来，没有验证。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/13/Vapor4-0概念/" itemprop="url">
                  Vapor4.0概念
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-13T10:34:02+08:00" content="Mar 13 2020">
              Mar 13 2020
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Vapor4-0/" itemprop="url" rel="index">
                    <span itemprop="name">Vapor4.0</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/03/13/Vapor4-0概念/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/03/13/Vapor4-0概念/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近打算学习一下后端的知识，心想怎样Javascript是绕不开的，就学Nodejs吧。学习了一个星期的Javascript和Nodejs，最后读了《深入浅出Node.js》有关Nodejs的历史，转身就跑去学Vapor了。</p>
<p>平台的发展都需要一定的时间，也有人坚定的从一开始走过来。Swift用起来那么顺，又经过几年的沉淀。现在是时候认真搞一搞了。</p>
<p>现在的想法是先建个博客练练手，后端用Vapor4.0，前端用Vue.js。两个技术一起学。将来可能把这个博客迁移过去。</p>
<p>Vapor4.0的文档还不够完善，大佬们建议从<a href="https://github.com/vapor/api-template" target="_blank" rel="noopener">vapor / api-template</a>这里搞起，记得分支选<code>4</code>。</p>
<p>对Vapor4要有大概的了解才能继续下去。看到Nodejs主要是通过<code>EventLoop</code>来接收请求的。就问问大佬们Vapor是怎么个机制。热心的大佬回复说Vapor底层用的SwiftNIO,其底层的逻辑和Nodejs差不多，SwiftNIO的这个机制叫做<code>EventLoopFuture</code>。网上查了些<a href="https://www.raywenderlich.com/1124580-swiftnio-a-simple-guide-to-async-on-the-server" target="_blank" rel="noopener">资料</a>, 摘录如下:</p>
<blockquote>
<p><strong>The Event Loop</strong></p>
</blockquote>
<blockquote>
<p>Efficiency is an important goal when writing server-side code. The more efficient your code, the more users it can help concurrently. Where an unoptimized app can only help ten to a hundred users at a time, highly optimized apps are able to help a hundred-thousand concurrent users on the same hardware.</p>
</blockquote>
<blockquote>
<p>The main reason for this difference is architectural. A poorly optimized app will be idle most of the time, whereas a highly optimized app will try to spend its time cleverly and actively. The brains behind this architecture in server-side Swift is provided by SwiftNIO, Apple’s cross-platform event-driven networking framework, by a type called EventLoop.</p>
</blockquote>
<blockquote>
<p>EventLoop is, in its essence, a while loop that keeps looking to do work when an external factor, such as a user uploading a file, has made progress.</p>
</blockquote>
<blockquote>
<p>If one thread writes to a variable, and another thread tries to read it or write to it at the same time, a race condition occurs, which will crash your app. One method you can use to prevent race conditions from occurring is using locks for each of these variables. You’ll lock this lock before accessing a variable and unlock is after accessing it is completed, so any future accesses to the resource are prevented until you’ll unlock the lock. The main downside of this approach is its complexity and impact on performance.</p>
</blockquote>
<blockquote>
<p>Using a single thread to access this information is another way to tackle the issue of race conditions. Doing this means all read and write operations are done by this thread. One example of this is the database you’ll find in the sample project. Using this method requires you to give the read/write thread a way to return the result to the event loop that requested it.</p>
</blockquote>
<blockquote>
<p>If you respond to a request from a different EventLoop, SwiftNIO will crash the app to prevent undefined behaviour from causing trouble.</p>
</blockquote>
<blockquote>
<p><strong>Futures and Promises</strong></p>
</blockquote>
<blockquote>
<p>Future is a type used to describe information that does not exist yet, but will exist in the future. Writing asynchronous code with futures means directing the futures to respond to the successful results or to the failures. You can create a future with a predefined result: either success or failure. However, if the result is not known yet, you need to create a Promise.</p>
</blockquote>
<blockquote>
<p>These promises and futures need to be created from the EventLoop since the future type will always return to the event loop it originated from. A future can only hold one result at a time, at which point it is considered completed. Completion can be either successful or unsuccessful, thus failed futures are also considered completed. Finally, if a promise is creates, it must be completed.</p>
</blockquote>
<p>现在就开始建立自己的新项目吧。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Changwei">
          <p class="site-author-name" itemprop="name">Changwei</p>
          <p class="site-description motion-element" itemprop="description">I develop iOS/Android apps with Swift/Kotlin language.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">78</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">34</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/cwtututu" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/thankforyou" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://cn.linkedin.com/pub/vale-tu/71/527/3a1/" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.upwork.com/o/profiles/users/_~01eeefc89751549361/" target="_blank" title="Upwork">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Upwork
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.peopleperhour.com/freelancer/changwei/tu/ios-android-developer-parse-layer/986083" target="_blank" title="peopleperhour">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  peopleperhour
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Changwei</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'tuchangwei';
      var disqus_identifier = 'index.html';
      var disqus_title = "";
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  

  

  

  

</body>
</html>
