<!doctype html>



  


<html class="theme-next muse use-motion">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css">


  <meta name="keywords" content="iOS Development, iPhone Development, Android Development, API Development">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1">






<meta name="description" content="I develop iOS/Android apps with Swift/Kotlin language.">
<meta property="og:type" content="website">
<meta property="og:title" content="Changwei&#39;s Blog">
<meta property="og:url" content="http://tuchangwei.github.com/index.html">
<meta property="og:site_name" content="Changwei&#39;s Blog">
<meta property="og:description" content="I develop iOS/Android apps with Swift/Kotlin language.">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Changwei&#39;s Blog">
<meta name="twitter:description" content="I develop iOS/Android apps with Swift/Kotlin language.">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://tuchangwei.github.com/">

  <title> Changwei's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Changwei's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">I develop iOS/Android apps with Swift/Kotlin language.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/aboutme" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/15/Vapor4-0学习记录3/" itemprop="url">
                  Vapor4.0学习记录3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-15T10:54:37+08:00" content="Mar 15 2020">
              Mar 15 2020
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>昨天周六，被Docker中配置Vapor搞到脑袋要炸，差一点放弃Vapor的学习。但今天感觉还好，脑炸是源于对未知的恐惧。</p>
<p>本身相关的包依赖下载就非常的耗时，稍个不慎还要重新下载，简直奔溃。</p>
<p>我的想法是先建个模版项目发布一下，熟悉整个流程后，就边加功能边发布。因为要保持环境的一致性，Vapor社区比较推荐在Docker中部署，然后再把Docker部署到服务器上，模版项目中也提供了两个Docker相关的文件 <code>Dockerfile</code> 和 <code>docker-compose.yml</code>。但是网络上关于Docker部署Vapor4的资料简直是没有，看着两个文件中的命令就头大。脑中的问题一直在飞： 本地项目怎么部署到Docker容器中？是不是要先在容器中安装Swift和Postpostgres?部署的项目和postpostrges是同一个容器，还是两个容器？这两个容器怎么交流？本地项目做了更改后，Docker中的项目会自动更改吗？这些问题怎么用命令行解决？谁想谁脑炸。</p>
<p>正当我要放弃的时候，社区的温暖送来了🙏。</p>
<blockquote>
<p>Deploying with docker is quite easy. Assuming you want to deploy a fresh Vapor 4 project:</p>
</blockquote>
<blockquote>
<p>Requirements: Install latest Xcode 11.4 Beta and switch to Swift 5.2 in the preferences. (You can check in the command line using swift –version) If you want to use Docker locally on your Mac, you should install Docker Desktop for Mac. </p>
</blockquote>
<blockquote>
<p>Run <code>vapor new --branch=4 myProject</code> to create a fresh project from template. (You can do any changes if you want, but the fresh template already provides a Hello World example.)</p>
</blockquote>
<blockquote>
<p>To run your application within Docker, there is already a <code>web.Dockerfile</code> provided in the template.<br>We’ll have to build an image first. Run <code>docker build -f web.Dockerfile -t my-project .</code>  Of course you can use whatever tag (my-project) you like.<br>To test your image locally use <code>docker run --rm -p 8080:80 my-project</code> (We use –rm to delete the container when we stop the app. The flag -p 8080:80 exposes the port 80 from within the container to port 8080 on our host.) You will see something like [ NOTICE ] Server starting on <a href="http://0.0.0.0:80" target="_blank" rel="noopener">http://0.0.0.0:80</a> in the command line. Visit <a href="http://localhost:8080/" target="_blank" rel="noopener">http://localhost:8080/</a> in your browser and you should see “It works!” from your Vapor application.</p>
</blockquote>
<blockquote>
<p>If you make changes to your application, stop the container, build and run it again.</p>
</blockquote>
<p>所以什么都不用管，先在项目目录下输入如下命令:</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">docker</span> <span class="keyword">build </span>-f Dockerfile -t tblog .</span><br></pre></td></tr></table></figure>
<p>项目就开始在Docker中安装了。注意命令后面那个<code>.</code>别忘了，那个是当前目录的意思。</p>
<p>完后我按照上面大佬的命令：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> <span class="comment">--rm -p 8080:80 tblog</span></span><br></pre></td></tr></table></figure></p>
<p>并没有把项目跑起来，这里可以从两处做一下更改。一个是把命令行改成：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">run</span> <span class="comment">--rm -p 8080:8080 tblog</span></span><br></pre></td></tr></table></figure></p>
<p>大佬说docker默认暴露的是8080端口。或者在<code>Dockerfile</code>文件中把最后一行改为：</p>
<blockquote>
<p>CMD [“serve”, “–env”, “production”, “–hostname”, “0.0.0.0”, “–port”, “80”]</p>
</blockquote>
<p>把80端口暴露出来。</p>
<p><code>Dockerfile</code>里的命令大概解释一下，就是先在Docker容器里下载Swift5.2, 然后把本地的项目拷贝到容器里，然后编译。然后再把Ubuntu拷贝下来，把编译的文件放在Ubuntu的目录结构下。然后运行。</p>
<p>这个时候项目跑起来是没有数据库的, 这个时候<code>docker-compose.yml</code>这个文件就有用了。</p>
<p>运行命令：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose <span class="meta">up</span> <span class="built_in">db</span></span><br></pre></td></tr></table></figure></p>
<p>会安装数据库postgres，并启动数据库。</p>
<p>运行命令：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose up migrate</span></span><br></pre></td></tr></table></figure></p>
<p>会在数据库中创建TOOD这个表。</p>
<p>这个时候，你再访问localhost:8080/todos这个API程序就不会报错了。这个数据库是建在另外一个容器里的。我们既可以通过运行命令：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose up app</span></span><br></pre></td></tr></table></figure></p>
<p>让前一个容器里的app启动，然后通过localhost:8080/todos去访问数据库，也可以直接在Xcode中运行app，然后通过这个URL去访问数据库。数据库是同一个，但是跑起来的app却是两个。Xcode跑的那个是开发用的。容器里的这个用来发布的。</p>
<p>如果运行命令：<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker-compose build</span></span><br></pre></td></tr></table></figure></p>
<p>它会执行<code>Dockerfile</code>里的命令。也就是说和前面docker build的命令差不多。</p>
<p>这些命令在<code>docker-compose.yml</code>中都有说明。</p>
<p>最后我发现原来docker在国内有镜像，可以加速下载images。具体方法看<a href="https://yeasy.gitbooks.io/docker_practice/install/mirror.html" target="_blank" rel="noopener">这里</a>。这个博客很不错，回头看看把Docker的知识补一补。</p>
<p>文中关于Docker的解释，我半靠理解半靠猜，但无论如何app是跑起来了，数据库也通了。后面慢慢练手，慢慢填坑。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/13/Vapor4-0学习记录2/" itemprop="url">
                  Vapor4.0学习记录2
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-13T20:50:10+08:00" content="Mar 13 2020">
              Mar 13 2020
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>太难了。</p>
<p>每一个项目都要重新下载Swift Package Dependencies，并不会把相同的库像Nodejs那样全局地装在本地。</p>
<p>命令行运行和Xcode运行，他们需要下载的Swift Package Dependencies在不同的位置。我本来在Xcode配置环境变量，想用命令行验证一下，结果，命令行也要重新下载一遍这些包。黑脸…</p>
<p>记录一下Xcode中环境配置的位置吧。上边可以配置环境。下边可以配置数据库的信息。</p>
<img src="/2020/03/13/Vapor4-0学习记录2/QQ20200313-210331.png">
<p>大神说命令行配置应该这样 <code>EXPORT DATABASE_HOST=vapor; vapor-beta run</code>, 因为命令行下包还没下下来，没有验证。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/03/13/Vapor4-0学习记录1/" itemprop="url">
                  Vapor4.0学习记录1
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2020-03-13T10:34:02+08:00" content="Mar 13 2020">
              Mar 13 2020
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近打算学习一下后端的知识，心想怎样Javascript是绕不开的，就学Nodejs吧。学习了一个星期的Javascript和Nodejs，最后读了《深入浅出Node.js》有关Nodejs的历史，转身就跑去学Vapor了。</p>
<p>平台的发展都需要一定的时间，也有人坚定的从一开始走过来。Swift用起来那么顺，又经过几年的沉淀。现在是时候认真搞一搞了。</p>
<p>现在的想法是先建个博客练练手，后端用Vapor4.0，前端用Vue.js。两个技术一起学。将来可能把这个博客迁移过去。</p>
<p>Vapor4.0的文档还不够完善，大佬们建议从<a href="https://github.com/vapor/api-template" target="_blank" rel="noopener">vapor / api-template</a>这里搞起，记得分支选<code>4</code>。</p>
<p>对Vapor4要有大概的了解才能继续下去。看到Nodejs主要是通过<code>EventLoop</code>来接收请求的。就问问大佬们Vapor是怎么个机制。热心的大佬回复说Vapor底层用的SwiftNIO,其底层的逻辑和Nodejs差不多，SwiftNIO的这个机制叫做<code>EventLoopFuture</code>。网上查了些<a href="https://www.raywenderlich.com/1124580-swiftnio-a-simple-guide-to-async-on-the-server" target="_blank" rel="noopener">资料</a>, 摘录如下:</p>
<blockquote>
<p><strong>The Event Loop</strong></p>
</blockquote>
<blockquote>
<p>Efficiency is an important goal when writing server-side code. The more efficient your code, the more users it can help concurrently. Where an unoptimized app can only help ten to a hundred users at a time, highly optimized apps are able to help a hundred-thousand concurrent users on the same hardware.</p>
</blockquote>
<blockquote>
<p>The main reason for this difference is architectural. A poorly optimized app will be idle most of the time, whereas a highly optimized app will try to spend its time cleverly and actively. The brains behind this architecture in server-side Swift is provided by SwiftNIO, Apple’s cross-platform event-driven networking framework, by a type called EventLoop.</p>
</blockquote>
<blockquote>
<p>EventLoop is, in its essence, a while loop that keeps looking to do work when an external factor, such as a user uploading a file, has made progress.</p>
</blockquote>
<blockquote>
<p>If one thread writes to a variable, and another thread tries to read it or write to it at the same time, a race condition occurs, which will crash your app. One method you can use to prevent race conditions from occurring is using locks for each of these variables. You’ll lock this lock before accessing a variable and unlock is after accessing it is completed, so any future accesses to the resource are prevented until you’ll unlock the lock. The main downside of this approach is its complexity and impact on performance.</p>
</blockquote>
<blockquote>
<p>Using a single thread to access this information is another way to tackle the issue of race conditions. Doing this means all read and write operations are done by this thread. One example of this is the database you’ll find in the sample project. Using this method requires you to give the read/write thread a way to return the result to the event loop that requested it.</p>
</blockquote>
<blockquote>
<p>If you respond to a request from a different EventLoop, SwiftNIO will crash the app to prevent undefined behaviour from causing trouble.</p>
</blockquote>
<blockquote>
<p><strong>Futures and Promises</strong></p>
</blockquote>
<blockquote>
<p>Future is a type used to describe information that does not exist yet, but will exist in the future. Writing asynchronous code with futures means directing the futures to respond to the successful results or to the failures. You can create a future with a predefined result: either success or failure. However, if the result is not known yet, you need to create a Promise.</p>
</blockquote>
<blockquote>
<p>These promises and futures need to be created from the EventLoop since the future type will always return to the event loop it originated from. A future can only hold one result at a time, at which point it is considered completed. Completion can be either successful or unsuccessful, thus failed futures are also considered completed. Finally, if a promise is creates, it must be completed.</p>
</blockquote>
<p>现在就开始建立自己的新项目吧。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/11/13/Android-三张图搞定Touch事件传递机制/" itemprop="url">
                  Android-三张图搞定Touch事件传递机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2017-11-13T10:56:59+08:00" content="Nov 13 2017">
              Nov 13 2017
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>转自: <a href="http://hanhailong.com/2015/09/24/Android-三张图搞定Touch事件传递机制/" target="_blank" rel="noopener">Android-三张图搞定Touch事件传递机制</a></p>
<p>之前看了很多关于Android事件Touch传递机制的文章，感觉还是老外讲的最清楚。原版PDF地址：<a href="http://wugengxin.cn/download/pdf/android/PRE_andevcon_mastering-the-android-touch-system.pdf" target="_blank" rel="noopener">Mastering the Android Touch System</a>，github的demo地址：<a href="https://github.com/devunwired/custom-touch-examples" target="_blank" rel="noopener">demo</a></p>
<p>上图之前先讲下Android事件的基础知识：</p>
<ol>
<li>所有的Touch事件都封装到MotionEvent里面</li>
<li>事件处理包括三种情况，分别为：传递—-dispatchTouchEvent()函数、拦截——onInterceptTouchEvent()函数、消费—-onTouchEvent()函数和OnTouchListener </li>
<li>事件类型分为ACTION_DOWN, ACTION_UP, ACTION_MOVE, ACTION_POINTER_DOWN, ACTION_POINTER_UP, ACTION_CANCEL等，每个事件都是以ACTION_DOWN开始ACTION_UP结束</li>
</ol>
<p>Android事件传递流程：</p>
<ol>
<li><p>事件都是从Activity.dispatchTouchEvent()开始传递</p>
</li>
<li><p>事件由父View传递给子View，ViewGroup可以通过onInterceptTouchEvent()方法对事件拦截，停止其向子view传递</p>
</li>
<li><p>如果事件从上往下传递过程中一直没有被停止，且最底层子View没有消费事件，事件会反向往上传递，这时父View(ViewGroup)可以进行消费，如果还是没有被消费的话，最后会到Activity的onTouchEvent()函数。</p>
</li>
<li><p>如果View没有对ACTION_DOWN进行消费，之后的其他事件不会传递过来，也就是说ACTION_DOWN必须返回true，之后的事件才会传递进来</p>
</li>
<li><p>OnTouchListener优先于onTouchEvent()对事件进行消费</p>
<hr>
<p>效果图如下：</p>
<ol>
<li><p>View不处理事件流程图（View没有消费事件）</p>
<img src="/2017/11/13/Android-三张图搞定Touch事件传递机制/view_touch_ignorant.png.jpeg">
</li>
<li><p>View处理事件</p>
<img src="/2017/11/13/Android-三张图搞定Touch事件传递机制/view_touch_interested.png.jpeg">
</li>
<li><p>事件拦截</p>
<img src="/2017/11/13/Android-三张图搞定Touch事件传递机制/view_touch_intercept.png.jpeg">
</li>
</ol>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/08/Two-Tips-When-You-Setup-Firebase-For-Remote-Notification/" itemprop="url">
                  Two Tips When You Setup Firebase for Remote Notification
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2017-04-08T16:24:00+08:00" content="Apr 8 2017">
              Apr 8 2017
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I finished my first android app written by Kotlin language recently. Today I want to record what I learned when I setup Firebase for remote notification.</p>
<p>There are two cases to disucuss.</p>
<h2 id="1-When-the-app-is-in-foreground"><a href="#1-When-the-app-is-in-foreground" class="headerlink" title="1. When the app is in foreground."></a>1. When the app is in foreground.</h2><p>This case is easier, when the push is coming, the callback method <code>onMessageReceived</code> in the class which extends <code>FirebaseMessagingService</code> will be invoked. </p>
<h2 id="2-When-the-app-is-in-the-background-or-is-killed"><a href="#2-When-the-app-is-in-the-background-or-is-killed" class="headerlink" title="2. When the app is in the background or is killed."></a>2. When the app is in the background or is killed.</h2><p>Under this case, the notification will show in the system tray first. when we click the notification, the app launcher will be open by default. We can get the push information from its <code>intent</code>.</p>
<p>But if you don’t want the default action, for example, in my app, the launcher is a Splash activity, I don’t want to deal with push information in the activity, how we can do?</p>
<p>Now, let us see how to send push to devices.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Method - POST</span><br><span class="line"></span><br><span class="line">EndPoint - <span class="string">https:</span><span class="comment">//fcm.googleapis.com/fcm/send</span></span><br><span class="line"></span><br><span class="line">Header - </span><br><span class="line"></span><br><span class="line"><span class="string">Authorization:</span>key=appkey</span><br><span class="line"></span><br><span class="line">Content-<span class="string">Type:</span>application/json</span><br><span class="line"></span><br><span class="line">Body - </span><br><span class="line"></span><br><span class="line">&#123;<span class="string">"notification"</span>: &#123;</span><br><span class="line">		<span class="string">"title"</span>: <span class="string">"Your Title"</span>,</span><br><span class="line">		 <span class="string">"text"</span>: <span class="string">"Your Text"</span>,</span><br><span class="line">		 <span class="string">"body"</span>: <span class="string">"Your body"</span>,</span><br><span class="line">		 <span class="string">"click_action"</span> : <span class="string">"PUSH"</span></span><br><span class="line">	&#125;,</span><br><span class="line"><span class="string">"data"</span>: &#123;</span><br><span class="line">    	<span class="string">"url"</span>: <span class="string">"xxx"</span></span><br><span class="line">    &#125;,</span><br><span class="line"><span class="string">"to"</span> : <span class="string">"pushToken"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The key-value <code>click_action</code> is the key point. I want MainActivity to initialize when the push is coming, so I config MainActivity in <code>AndroidManifest.xml</code> file</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity    android:name=<span class="string">".activities.MainActivity"</span>    android:configChanges=<span class="string">"keyboardHidden|orientation"</span>    </span><br><span class="line">android:launchMode=<span class="string">"singleInstance"</span>    </span><br><span class="line">android:screenOrientation=<span class="string">"portrait"</span>&gt;    </span><br><span class="line">	&lt;intent-filter&gt;        </span><br><span class="line">	&lt;action android:name=<span class="string">"PUSH"</span> /&gt;        </span><br><span class="line">	&lt;category android:name=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;   </span><br><span class="line">	&lt;/intent-filter&gt;</span><br><span class="line">&lt;/activity&gt;</span><br></pre></td></tr></table></figure>
<p>Note the action’s name in <code>intent-filter</code> is same with the value of the key <code>click_action</code>.</p>
<p>Further more, if the MainActivity is in the background, I don’t want to initilize a new one, so I set <code>android:launchMode=&quot;singleInstance&quot;</code> . This way, when the push is coming out, we can get its <code>intent</code> from the following callback method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">override fun <span class="title">onNewIntent</span><span class="params">(intent: Intent?)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.action == <span class="string">"PUSH"</span> &amp;&amp; intent.getStringExtra(<span class="string">"url"</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            requestPushContent(intent.getStringExtra(<span class="string">"url"</span>))</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Done!</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/11/02/RxSwift-application-architectures/" itemprop="url">
                  RxSwift Application Architectures
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-11-02T10:34:13+08:00" content="Nov 2 2016">
              Nov 2 2016
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/RxSwift/" itemprop="url" rel="index">
                    <span itemprop="name">RxSwift</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>View Controllers</li>
<li>View Models</li>
<li>Models</li>
<li>Backend services</li>
<li>AppCoordinator (Singleton)</li>
</ol>
<p>More references:</p>
<p><a href="https://slack-files.com/T051G5Y6D-F0HABHKDK-8e9141e191" target="_blank" rel="noopener">https://slack-files.com/T051G5Y6D-F0HABHKDK-8e9141e191</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/31/MVVM-Philosophy/" itemprop="url">
                  MVVM Philosophy
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-10-31T15:59:02+08:00" content="Oct 31 2016">
              Oct 31 2016
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/MVVM/" itemprop="url" rel="index">
                    <span itemprop="name">MVVM</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Philosophy"><a href="#Philosophy" class="headerlink" title="Philosophy"></a><a href="https://github.com/devxoul/RxTodo" target="_blank" rel="noopener">Philosophy</a></h2><ul>
<li><p>View doesn’t have control flow. View cannot modify the data. View only knows how to map the data.</p>
<p>  <strong>Bad</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">viewModel.title</span><br><span class="line">    .<span class="built_in">map</span> &#123; $<span class="number">0</span> + <span class="string">"!"</span> &#125; <span class="comment">// Bad: View should not modify the data</span></span><br><span class="line">    .bindTo(<span class="keyword">self</span>.titleLabel)</span><br></pre></td></tr></table></figure>
<p>  <strong>Good</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">viewModel.title</span><br><span class="line">    .bindTo(<span class="keyword">self</span>.titleLabel)</span><br></pre></td></tr></table></figure>
</li>
<li><p>View doesn’t know what ViewModel does. View can only communicate to ViewModel about what View did.</p>
<p>  <strong>Bad</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">viewModel.login() <span class="comment">// Bad: View should not know what ViewModel does (login)</span></span><br></pre></td></tr></table></figure>
<p>  <strong>Good</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.loginButton.rx_tap</span><br><span class="line">    .bindTo(viewModel.loginButtonDidTap) <span class="comment">// "Hey I clicked the login button"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.usernameInput.rx_controlEvent(.<span class="type">EditingDidEndOnExit</span>)</span><br><span class="line">    .bindTo(viewModel.usernameInputDidReturn) <span class="comment">// "Hey I tapped the return on username input"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Model is hidden by ViewModel. ViewModel only exposes the minimum data so that View can render.</p>
<p>  <strong>Bad</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProductViewModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> product: <span class="type">Driver</span>&lt;<span class="type">Product</span>&gt; <span class="comment">// Bad: ViewModel should hide Model</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>  <strong>Good</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ProductViewModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> productName: <span class="type">Driver</span>&lt;<span class="type">String</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> formattedPrice: <span class="type">Driver</span>&lt;<span class="type">String</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> formattedOriginalPrice: <span class="type">Driver</span>&lt;<span class="type">String</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> originalPriceHidden: <span class="type">Driver</span>&lt;<span class="type">Bool</span>&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<img src="/2016/10/31/MVVM-Philosophy/mvvm.png">
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/21/译-两分钟介绍Rx/" itemprop="url">
                  [译]两分钟介绍Rx
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-10-21T17:28:49+08:00" content="Oct 21 2016">
              Oct 21 2016
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Rx/" itemprop="url" rel="index">
                    <span itemprop="name">Rx</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>原文在<a href="https://medium.com/@andrestaltz/2-minute-introduction-to-rx-24c8ca793877#.ww2g1z3oo" target="_blank" rel="noopener">这里</a>, 本文用<a href="http://www.typora.io/" target="_blank" rel="noopener">Typora</a>编辑</strong></p>
<p>你可能已经看了我写的<a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754" target="_blank" rel="noopener">这篇文章</a>。太长了？好吧。</p>
<p>Rx并不是那么难，你自己也可以创造它。继续阅读吧。</p>
<p>你知道数组吗？你当然知道。这里有一个：</p>
<font style="font-size:30px;"><em>[14, 9, 5, 2, 10, 13, 4]</em></font>

<p></p><p></p>
<p>如果我告诉你这是个不可变的数组，你需要拿走所有的奇数，你会怎么做呢？这是一个流行的方式：</p>
<font style="font-size:30px;"><em>[14, 9, 5, 2, 10, 13, 4]</em><br><br><em>filter( (x) -&gt; x % 2 == 0 )</em><br><br><em>[ 14, 2, 10, 4 ]</em></font>

<p>到现在为止，没什么新东西。这很普遍，它来自于函数式编程的范例。</p>
<p>…</p>
<p>现在想象一下鼠标位置的点击事件。如果你把它们画在一个时间线上，它们看起来是这样的：</p>
<img src="/2016/10/21/译-两分钟介绍Rx/1-FjTqms95LbK_ztsZXiNpoQ.png">
<p>朋友，这是一个事件流，我们亲切的叫它 <code>Observable</code>。</p>
<p>这个点击事件来自于鼠标，因此整个的事件流是不可变的，在这种场景下，当它被定义之后，你不能增加或移除它。</p>
<p>但是如果我只对x &lt; 250 的点击事件感兴趣呢？那我们能不能也创建一个新的事件流就像我们过滤数组那样呢？</p>
<img src="/2016/10/21/译-两分钟介绍Rx/2-FjTqms95LbK_ztsZXiNpoQ.png">
<p></p><p></p>
<font style="font-size:30px;"><center><em>filter( (event) -&gt; event.x &lt; 250 )</em></center></font>

<p></p><p></p>
<img src="/2016/10/21/译-两分钟介绍Rx/1-DvH5Iqul7Nxor7r7AencgA.png">
<p>那么不变的数组和<code>Observables</code> 有什么不同吗？并不多。你可以对两者使用<code>map</code>, <code>filter</code>, <code>reduct</code>。对于<code>Observables</code> 你还可以使用<code>merge</code>, <code>delay</code>, <code>concat</code>, <code>buffer</code>, <code>distinct</code> , <code>first</code>, <code>last</code>, <code>zip</code>, <code>startWith</code>, <code>widnow</code>, <code>takeUntil</code>, <code>skip</code>, <code>scan</code>, <code>sample</code>, <code>amb</code>, <code>join</code>, <code>flatMap</code>.</p>
<p><strong>把它想象成一个异步的不可变的数组。</strong></p>
<p>Rx在underscore.js中是为事件服务的。但是等一等，什么是事件？难道你app中的大部分东西不都是事件吗？</p>
<p>事件“程序开始”，事件“API响应接收”，事件“键盘按键被点击”，事件“设备休眠”，等等。</p>
<p>虚拟的任何东西都能看作是事件流。它只是和它的构成与合适的组合有关。</p>
<p>嗯，这就是两分钟Rx。</p>
<blockquote>
<p>What’s the difference between an array and events?</p>
</blockquote>
<blockquote>
<p>— <a href="https://www.youtube.com/watch?v=FAZJsxcykPs&amp;list=PLfXiENmg6yyU5kEHyo1kYkq7HEzBOoiTT#t=365" target="_blank" rel="noopener">Erik Meijer</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/15/Android-导出app中的数据库/" itemprop="url">
                  [Android]导出app中的数据库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-15T00:21:14+08:00" content="Aug 15 2016">
              Aug 15 2016
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近做iOS项目，需要把Android端的数据库导出来比较一下，这个还挺麻烦。</p>
<p>如果用模拟器的话，可以直接用DDMS查看数据库的路径，然后导出，这样最方便。但我这个项目需要用到Google的服务， 模拟器上无法运行。</p>
<p>如果是真机，在不越狱的情况下是无法查看数据库路径的，没办法，只能用代码把数据库拷贝到SDCard上，然后用<code>File Manager</code>这个app把数据库文件导出来。</p>
<p>用代码拷贝文件到SDCard上，需要在<code>AndroidManifest.xml</code>文件中加入如下权限：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:<span class="attribute">name</span>=<span class="string">"android.permission.MOUNT_UNMOUNT_FILESYSTEMS"</span>/&gt;</span><br><span class="line">&lt;uses-permission android:<span class="attribute">name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<p>如果你的真机是6.0以上的系统，还需要在程序中向用户请求权限：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">requestPermission</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ContextCompat.checkSelfPermission(<span class="keyword">this</span>,</span><br><span class="line">            android.Manifest.permission.WRITE_EXTERNAL_STORAGE)</span><br><span class="line">            != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Should we show an explanation?</span></span><br><span class="line">        <span class="keyword">if</span> (ActivityCompat.shouldShowRequestPermissionRationale(<span class="keyword">this</span>,</span><br><span class="line">                android.Manifest.permission.WRITE_EXTERNAL_STORAGE)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Show an expanation to the user *asynchronously* -- don't block</span></span><br><span class="line">            <span class="comment">// this thread waiting for the user's response! After the user</span></span><br><span class="line">            <span class="comment">// sees the explanation, try again to request the permission.</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// No explanation needed, we can request the permission.</span></span><br><span class="line"></span><br><span class="line">            ActivityCompat.requestPermissions(<span class="keyword">this</span>,</span><br><span class="line">                    <span class="keyword">new</span> String[]&#123;android.Manifest.permission.WRITE_EXTERNAL_STORAGE&#125;,</span><br><span class="line">                    <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// MY_PERMISSIONS_REQUEST_READ_CONTACTS is an</span></span><br><span class="line">            <span class="comment">// app-defined int constant. The callback method gets the</span></span><br><span class="line">            <span class="comment">// result of the request.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        copyDatabase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> onRequestPermissionsResult(<span class="keyword">int</span> requestCode,</span><br><span class="line">                                           String permissions[], <span class="keyword">int</span>[] grantResults) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: &#123;</span><br><span class="line">                <span class="comment">// If request is cancelled, the result arrays are empty.</span></span><br><span class="line">                <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span></span><br><span class="line">                        &amp;&amp; grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                    copyDatabase();</span><br><span class="line">                    <span class="comment">// permission was granted, yay! Do the</span></span><br><span class="line">                    <span class="comment">// contacts-related task you need to do.</span></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// permission denied, boo! Disable the</span></span><br><span class="line">                    <span class="comment">// functionality that depends on this permission.</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// other 'case' lines to check for other</span></span><br><span class="line">            <span class="comment">// permissions this app might request</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后，将数据库拷贝到SDCard。<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> copyDatabase() &#123;</span><br><span class="line">        <span class="keyword">String</span> dbPath = <span class="string">"/data/data/&lt;packageName&gt;/databases/"</span> + DatabaseName;</span><br><span class="line">        <span class="built_in">File</span> file = <span class="keyword">new</span> <span class="built_in">File</span>(dbPath);</span><br><span class="line">        <span class="built_in">if</span> (file.<span class="built_in">exists</span>()) &#123;</span><br><span class="line">            <span class="built_in">File</span> dbCopy = <span class="keyword">new</span> <span class="built_in">File</span>(Environment.getExternalStorageDirectory().getAbsolutePath(), <span class="string">"copy.db"</span>);</span><br><span class="line">            <span class="built_in">try</span> &#123;</span><br><span class="line">                BufferedInputStream in = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(dbPath));</span><br><span class="line">                BufferedOutputStream out = <span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(dbCopy));</span><br><span class="line">                <span class="keyword">byte</span>[] bb = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">int</span> n;</span><br><span class="line">                <span class="built_in">while</span> ((n = in.<span class="built_in">read</span>(bb)) != <span class="number">-1</span>) &#123;</span><br><span class="line">                    out.<span class="built_in">write</span>(bb, <span class="number">0</span>, n);</span><br><span class="line">                &#125;</span><br><span class="line">                out.<span class="built_in">close</span>();</span><br><span class="line">                in.<span class="built_in">close</span>();</span><br><span class="line">            &#125; <span class="built_in">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="built_in">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/18/The-solution-that-the-menu-item-of-Navigation-View-can-t-change-its-background-When-it-is-selected-checked/" itemprop="url">
                  The Solution That the Menu Item of Navigation View Can't Change Its Background When It Is Selected/checked.
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-07-18T10:08:03+08:00" content="Jul 18 2016">
              Jul 18 2016
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Today, when I created a left navigation bar in android app, I met a strange issue. That was I couldn’t appoint a background color for the navigation item when it was selected. Like this:</p>
<img src="/2016/07/18/The-solution-that-the-menu-item-of-Navigation-View-can-t-change-its-background-When-it-is-selected-checked/no-background.gif">
<p> It was annoying, I found many answers on the internet, but they all couldn’t fix my issue.</p>
<p>Most of answers said I should created a selector in drawable folder, like:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">"@color/primary"</span> <span class="attr">android:state_checked</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:drawable</span>=<span class="string">"@android:color/transparent"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>and set NavigationView like:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app:itemBackground="@drawable/nav_view_item_background"</span><br></pre></td></tr></table></figure>
<p>For me, it is not the correct answer. Though I set the <code>state_checked</code> is true and give it a drawable color, it seems the item is never checked.</p>
<p>For more search, I found the issue was happened with menu item.<br>The original menu file is:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">menu</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:title</span>=<span class="string">"主题"</span> <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_dashboard_grey"</span> <span class="attr">android:id</span>=<span class="string">"@+id/theme"</span> <span class="attr">android:checked</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:title</span>=<span class="string">"节点"</span> <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_view_agenda_grey"</span> <span class="attr">android:id</span>=<span class="string">"@+id/node"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:title</span>=<span class="string">"其他"</span> <span class="attr">android:id</span>=<span class="string">"@+id/other"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">menu</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:title</span>=<span class="string">"关于"</span> <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_info_grey"</span> <span class="attr">android:id</span>=<span class="string">"@+id/about"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">menu</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Then I add a tag <code>android:checkable=true</code> to it:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">menu</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:title</span>=<span class="string">"主题"</span> <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_dashboard_grey"</span> <span class="attr">android:id</span>=<span class="string">"@+id/theme"</span> <span class="attr">android:checked</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:checkable</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:title</span>=<span class="string">"节点"</span> <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_view_agenda_grey"</span> <span class="attr">android:id</span>=<span class="string">"@+id/node"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:checkable</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:title</span>=<span class="string">"其他"</span> <span class="attr">android:id</span>=<span class="string">"@+id/other"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">menu</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:title</span>=<span class="string">"关于"</span> <span class="attr">android:icon</span>=<span class="string">"@drawable/ic_info_grey"</span> <span class="attr">android:id</span>=<span class="string">"@+id/about"</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">android:checkable</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">menu</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">menu</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Now, the effect is normal.</p>
<img src="/2016/07/18/The-solution-that-the-menu-item-of-Navigation-View-can-t-change-its-background-When-it-is-selected-checked/background.gif">

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Changwei">
          <p class="site-author-name" itemprop="name">Changwei</p>
          <p class="site-description motion-element" itemprop="description">I develop iOS/Android apps with Swift/Kotlin language.</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">71</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/cwtututu" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/thankforyou" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://cn.linkedin.com/pub/vale-tu/71/527/3a1/" target="_blank" title="Linkedin">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Linkedin
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.upwork.com/o/profiles/users/_~01eeefc89751549361/" target="_blank" title="Upwork">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Upwork
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.peopleperhour.com/freelancer/changwei/tu/ios-android-developer-parse-layer/986083" target="_blank" title="peopleperhour">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  peopleperhour
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Changwei</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
